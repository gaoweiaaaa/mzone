(function(win){var kalv_client_id="undefined";var serial_id=1;var STATS={START:0,STOP:1};var stat=STATS.STOP;var listeners={0:function(code,subject,flag,tokenCode){return}};var reverse_listeners={"default":0};var con_error_try_count=0;var cache={};function setClientId(clientId){kalv_client_id=clientId}function addListener(id,scene,func){listeners[id]=func;reverse_listeners[scene]=id}function getListener(id){if(typeof listeners[id]=="undefined"){return listeners[0]}return listeners[id]}function removeListener(scene){if(typeof(reverse_listeners[scene]==undefined)){return}var id=reverse_listeners[scene];delete reverse_listeners[scene];delete listeners[id]}function isExist(scene){if(typeof reverse_listeners[scene]==undefined){return reverse_listeners[scene]}return-1}function applyListenerId(){return serial_id++}function messageHandle(message){var func=getListener(message.id);if(typeof func=="undefined"){return}func(message.code,message.subject,message.flag,message.tokenCode)}function KeepAlive(){if(kalv_client_id=="undefined"){cache[0]={}}else{$.ajax({url:"//passport.58.com/keepalive/connect",dataType:"jsonp",data:{clientId:kalv_client_id},success:function(data){var code=data.code;if(code==0){if(stat==STATS.START){for(message in data.messages){messageHandle(data.messages[message])}}}if(code!=-2){if(stat==STATS.START){KeepAlive()}}},error:function(){if(stat==STATS.START&&con_error_try_count<3){setTimeout(function(){KeepAlive()},3e3)}con_error_try_count++}})}}function init(){if(kalv_client_id=="undefined"){$.ajax({url:"//passport.58.com/keepalive/clientid",dataType:"jsonp",success:function(data){var code=data.code;if(code==0){setClientId(data.clientId);for(var listenerId in cache){if(listenerId==0){KeepAlive()}else{KeepAliveLib.getQrcodeUrl(cache[listenerId].scene,cache[listenerId].source,cache[listenerId].successFunc,cache[listenerId].listenerFunc)}}stat=STATS.START}}})}}var KeepAliveLib={start:function(){var preStat=stat;stat=STATS.START;if(preStat==STATS.STOP){init();KeepAlive()}},stop:function(){stat=STATS.STOP},isOpen:function(){return stat==STATS.START},getQrcodeUrl:function(scene,source,successFunc,listenerFunc){var listenerId=applyListenerId();if(kalv_client_id=="undefined"){cache[listenerId]={scene:scene,source:source,successFunc:successFunc,listenerFunc:listenerFunc};if(!$.KeepAliveLib.isOpen()){$.KeepAliveLib.start()}}else{$.ajax({url:"//passport.58.com/keepalive/qrcode/imgurl",dataType:"jsonp",data:{clientId:kalv_client_id,listenerId:listenerId,scene:scene,source:source},success:function(data){if(data.code==0){var result=isExist(scene);if(result>0){removeListener(scene)}addListener(listenerId,scene,listenerFunc)}successFunc(data.code,data.url)},error:function(){successFunc(-1,"")}})}}};if(typeof win.$==="undefined"){win.$={}}win.$.KeepAliveLib=KeepAliveLib})(window);